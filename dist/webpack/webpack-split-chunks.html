<!doctype html><html class="" data-reactroot=""><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端笔记"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">webpack代码分片 · Ding前端笔记</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><header><h1 class="hide_on_mobile"><a href="/">Ding前端笔记</a></h1><nav><ul><li class="show_on_mobile flex_center"><a class="czs-menu-l" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a></li><li class="show_on_mobile"><h1 class="mobile_title"><a href="/">Ding前端笔记</a></h1></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul></nav></header><aside class="sidebar"><ol class="list_style_none"><li class=""><a href="/index.html" class="nav_link">Hello world</a></li><li class="unfold"><a href="/WebAPI/README.md" class="nav_link">WebAPI/README.md<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"></ol></li><li class="unfold"><a href="/HTTP/index.html" class="nav_link">HTTP协议与浏览器<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/HTTP/browser.html" class="nav_link">浏览器</a></li><li class=""><a href="/HTTP/HTTP.html" class="nav_link">HTTP协议请求方法和状态码</a></li><li class=""><a href="/HTTP/internet-hardware.html" class="nav_link">网络硬件</a></li></ol></li><li class="unfold"><a href="/js/todo.md" class="nav_link">js/todo.md<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/js/basics.html" class="nav_link">JavaScript基础</a></li><li class=""><a href="/js/Object.html" class="nav_link">基础</a></li><li class=""><a href="/js/context.html" class="nav_link">执行上下文</a></li><li class=""><a href="/js/closure.html" class="nav_link">闭包和面向对象</a></li><li class=""><a href="/js/regex.html" class="nav_link">正则</a></li><li class=""><a href="/js/algo.html" class="nav_link">算法</a></li><li class=""><a href="/js/design-patterns.html" class="nav_link">JS设计模式</a></li></ol></li><li class="unfold"><a href="/TS/index.html" class="nav_link">TS<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/TS/basics.html" class="nav_link">TS基础</a></li><li class=""><a href="/TS/enum.html" class="nav_link">TS枚举 类型 接口 泛型</a></li></ol></li><li class="unfold"><a href="/vue/index.html" class="nav_link">Vue<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/vue/vue-skills.html" class="nav_link">Vue开发技巧</a></li><li class=""><a href="/vue/vue-communication.html" class="nav_link">Vue组件通信</a></li><li class=""><a href="/vue/vue-router/vue-router.html" class="nav_link">Vue路由</a></li></ol></li><li class=""><a href="/react/lifecycle.html" class="nav_link">React的生命周期</a></li><li class="unfold"><a href="/webpack/index.html" class="nav_link">Webpack<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/webpack/webpack-use.html" class="nav_link">webpack的使用</a></li><li class=""><a href="/webpack/webpack-principle.html" class="nav_link">Webpack打包原理解析</a></li><li class=""><a href="/webpack/webpack-dev-config.html" class="nav_link">生产环境配置</a></li><li class=""><a href="/webpack/webpack-custom-loader.html" class="nav_link">实现自己的loader</a></li><li class=""><a href="/webpack/webpack-custom-plugin.html" class="nav_link">实现自己的plugin</a></li><li class=""><a href="/webpack/webpack-split-chunks.html" class="nav_link active">webpack代码分片</a></li><li class=""><a href="/webpack/webpack-dev-server-hmr.html" class="nav_link">webpack-dev-server 与 HMR</a></li></ol></li><li class=""><a href="/web-monitor/web-monitor.html" class="nav_link">前端监控简介</a></li><li class=""><a href="/git/git.html" class="nav_link">Git使用</a></li></ol></aside><section class="main"><div class="main_article"><article><h1>webpack代码分片</h1>
<h2 id="%E9%80%9A%E8%BF%87%E5%85%A5%E5%8F%A3%E6%8B%86%E5%88%86%E4%BB%A3%E7%A0%81">通过入口拆分代码<a class="anchor" href="#%E9%80%9A%E8%BF%87%E5%85%A5%E5%8F%A3%E6%8B%86%E5%88%86%E4%BB%A3%E7%A0%81">§</a></h2>
<p>webpack中每个入口都将生成一份对应的资源文件</p>
<pre class="language-autoit"><code class="language-autoit"><span class="token operator">/</span><span class="token operator">/</span> webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js
entry<span class="token punctuation">:</span> {
  app<span class="token punctuation">:</span> <span class="token string">'./main.js'</span><span class="token punctuation">,</span>
  lib<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'liba'</span><span class="token punctuation">,</span> <span class="token string">'libb'</span><span class="token punctuation">]</span>
}
</code></pre>
<p>适合将对象挂载到window上的库</p>
<h2 id="commonschunkplugin">CommonsChunkPlugin<a class="anchor" href="#commonschunkplugin">§</a></h2>
<p>webpack3.X适用，主要用于多入口之间的公共模块，也可用于提取单页面的模块</p>
<pre class="language-autoit"><code class="language-autoit">new webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span><span class="token function">CommonChunkPlugin</span><span class="token punctuation">(</span>{
  name<span class="token punctuation">:</span> <span class="token string">'common'</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 用于指定公共chunk的名字
  filename<span class="token punctuation">:</span> <span class="token string">'common.js'</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 提取后的资源名字
  chunks<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token operator">/</span><span class="token operator">/</span> 提取范围，对应entry里的chunk
  minChunks<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 数字 被<span class="token number">3</span>以上入口引用才提取，不影响entry中单独配置的提取数组  还可以设置<span class="token function">Infinity</span><span class="token punctuation">(</span>不自动抽离公共模块<span class="token punctuation">)</span> 和 函数<span class="token punctuation">,</span>
}<span class="token punctuation">)</span>
<span class="token operator">/</span><span class="token operator">/</span> 需要在页面上 在其他js之前引入common<span class="token punctuation">.</span>js
</code></pre>
<pre class="language-autoit"><code class="language-autoit"><span class="token operator">/</span><span class="token operator">/</span> 提取单页面 
entry<span class="token punctuation">:</span> {
  app<span class="token punctuation">:</span> <span class="token string">'./main.js'</span><span class="token punctuation">,</span>
  common<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">]</span> <span class="token operator">/</span><span class="token operator">/</span> 提取第三方类库及业务中不常更新的模块
}
<span class="token operator">/</span><span class="token operator">/</span> 插件配置同上
</code></pre>
<p>当minChunks为函数时，每个模块都会经该函数处理，传入当前依赖模块的信息module，以及被作为公共模块的数量count，可以在函数中针对每一个模块做更精细化的控制，返回值为true时进行提取。</p>
<pre class="language-autoit"><code class="language-autoit">minChunks<span class="token punctuation">:</span> <span class="token function">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> count<span class="token punctuation">)</span> {
  <span class="token operator">/</span><span class="token operator">/</span> module<span class="token punctuation">.</span>context 模块目录路径
  <span class="token operator">/</span><span class="token operator">/</span> module<span class="token punctuation">.</span>sourece 模块目录的完整路径
  <span class="token operator">/</span><span class="token operator">/</span> count 模块被引用的次数
   return module<span class="token punctuation">.</span>context <span class="token operator">&amp;</span><span class="token operator">&amp;</span>   module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"node_modules"</span><span class="token punctuation">)</span><span class="token comment">; </span>
  <span class="token operator">/</span><span class="token operator">/</span> node_modules 目录下的模块都作为公共部分，效果就如同 webpack <span class="token number">4</span><span class="token punctuation">.</span>x 中的 test<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"node_modules"</span><span class="token punctuation">)</span>
}
</code></pre>
<p>提取webpack的运行时，防止影响公共模块的hash，mainfest的CommonsChunkPlugin必须出现在最后，在页面中引入必须在最前</p>
<pre class="language-autoit"><code class="language-autoit">new webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span><span class="token function">CommonChunkPlugin</span><span class="token punctuation">(</span>{
  name<span class="token punctuation">:</span><span class="token string">'mainfest'</span>
}<span class="token punctuation">)</span>
</code></pre>
<p><strong>不足</strong></p>
<ul>
<li>
<p>提取特定入口的特定模块</p>
</li>
<li>
<p>只能提取一个vendor，想提取多个需要配置多次，</p>
</li>
<li>
<p>mainfest会使浏览器多加载一个资源</p>
</li>
<li>
<p>异步情况下会有问题</p>
</li>
</ul>
<p>webpack为每个面模块指定的id是按数字递增的，当有新的模块产生时会导致其他的模块id变化，可能影响vendor的hash。</p>
<p>解决办法，使用 HashedModuleIds-Plugin 为每个模块按照其所在的路径生成hash id</p>
<pre class="language-autoit"><code class="language-autoit">new HashedModuleIds<span class="token operator">-</span><span class="token function">Plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">/</span><span class="token operator">/</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> CommonsChunksPlugin
</code></pre>
<h3 id="webpack4x%E9%80%82%E7%94%A8optimizationsplitchunks-%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2">webpack4.x适用optimization.SplitChunks 代码分割<a class="anchor" href="#webpack4x%E9%80%82%E7%94%A8optimizationsplitchunks-%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2">§</a></h3>
<p>可以设置提取的条件：提取的模式，提取模块的体积</p>
<p>基础配置</p>
<pre class="language-autoit"><code class="language-autoit">optimization<span class="token punctuation">:</span>{    <span class="token operator">/</span><span class="token operator">/</span>帮我们自动做代码分割    
  splitChunks<span class="token punctuation">:</span>{        
    chunks<span class="token punctuation">:</span><span class="token string">"all"</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">/</span>默认是支持异步，all代表所有的chunks代码公共部分抽离出来成为一个单独的文件 
   } 
}
</code></pre>
<p>使用</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">//webpack.config.js </span>
entry<span class="token operator">:</span> <span class="token punctuation">{</span>
  lodash<span class="token operator">:</span> <span class="token string">"./lodash.js"</span><span class="token punctuation">,</span>
  index<span class="token operator">:</span> <span class="token string">"./index.js"</span>
  <span class="token comment">// vnedor: ['react', 'lodash', ...] // 指定公共使用的第三方类库</span>
<span class="token punctuation">}</span>
<span class="token comment">//指定打包后的资源位置  </span>
output<span class="token operator">:</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./build"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  filename<span class="token operator">:</span> <span class="token string">"[name].js"</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 全部配置</span>
optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
  splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
    chunks<span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span> <span class="token comment">// 对所有chunks生效，如果不配置，默认只对异步资源生效 async（默认） initial all</span>
    minSize<span class="token operator">:</span> <span class="token punctuation">{</span>
      javascript<span class="token operator">:</span><span class="token number">30000</span><span class="token punctuation">,</span> <span class="token comment">// 当模块大于30kb</span>
      style<span class="token operator">:</span><span class="token number">50000</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    maxSize<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 对模块进行二次分割时使用，不推荐</span>
    minChunks<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 打包成chunk最少有几个引用</span>
    maxAsyncRequests<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 异步加载并行请求并行请求最大资源数</span>
    maxInitialReauests<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 首次加载 入口文件并行最大资源数</span>
    automaticNameDelimiter<span class="token operator">:</span><span class="token string">'~'</span><span class="token punctuation">,</span> <span class="token comment">// 分隔符</span>
    name<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 根据cacheGroups和作用范围自动生成chunk命名</span>
    cacheGroups<span class="token operator">:</span> <span class="token punctuation">{</span>
      vendors<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 用于提取所有 node_modules 中符合条件的模块</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        priority<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span> <span class="token comment">// 数字越大 优先级越高</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// default则作用于被多次引用的模块</span>
        minChunks<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
        priority<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
        resuseExistingChunk<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-autoit"><code class="language-autoit"><span class="token operator">/</span><span class="token operator">/</span> 在entry里指定
entry<span class="token punctuation">:</span> {
  vendor<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"react"</span><span class="token punctuation">,</span> <span class="token string">"lodash"</span><span class="token punctuation">,</span> <span class="token string">"angular"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 指定公共使用的第三方类库
}
<span class="token operator">/</span><span class="token operator">/</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
vendor<span class="token punctuation">:</span> {
          chunks<span class="token punctuation">:</span> <span class="token string">"initial"</span><span class="token punctuation">,</span>
          test<span class="token punctuation">:</span> <span class="token string">"vendor"</span><span class="token punctuation">,</span>
          name<span class="token punctuation">:</span> <span class="token string">"vendor"</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 使用 vendor 入口作为公共部分
          enforce<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        }
 
<span class="token operator">/</span><span class="token operator">/</span> 使用test来匹配react<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
vendor<span class="token punctuation">:</span> {
          test<span class="token punctuation">:</span> <span class="token operator">/</span>react|vue|lodash<span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 直接使用 test 来做路径匹配
          chunks<span class="token punctuation">:</span> <span class="token string">"initial"</span><span class="token punctuation">,</span>
          name<span class="token punctuation">:</span> <span class="token string">"vendor"</span><span class="token punctuation">,</span>
          enforce<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        }

<span class="token operator">/</span><span class="token operator">/</span> 所有在 node\_modules 下的模块，即作为依赖安装的，都作为公共部分
vendor<span class="token punctuation">:</span> {
          chunks<span class="token punctuation">:</span> <span class="token string">"initial"</span><span class="token punctuation">,</span>
          test<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"node_modules"</span><span class="token punctuation">)</span> <span class="token operator">/</span><span class="token operator">/</span> 路径在 node_modules 目录下的都作为公共部分
          name<span class="token punctuation">:</span> <span class="token string">"vendor"</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 使用 vendor 入口作为公共部分
          enforce<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        }<span class="token punctuation">,</span>
</code></pre>
<ul>
<li>提取后的chunks可被共享，或者来自node_modules</li>
<li>提取后的js chunk大于30kB，CSS chunk大于50kB</li>
<li>按需加载时，并行请求的资源最大值小于等于5</li>
<li>首次加载时（不计算异步资源），并行请求的资源最大值小于等于3</li>
</ul>
<h2 id="%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD">异步加载<a class="anchor" href="#%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD">§</a></h2>
<p>正常加载  <code>import  bar from './bar.js'</code>    异步加载 <code>import('./bar.js').then()</code></p>
<p>配置异步加载的chunk名</p>
<pre class="language-autoit"><code class="language-autoit">output<span class="token punctuation">:</span> {
  chunkFileName<span class="token punctuation">:</span> <span class="token string">'[name].js'</span>
}
<span class="token function">import</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token operator">*</span> webpackChunkName<span class="token punctuation">:</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">/</span> <span class="token string">'./bar.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> {}<span class="token punctuation">)</span>
</code></pre>
<p>如果不添加webpackName会以module id数字的形式命名，这个数字有webpack基于模块自动生成，可能会随着其他模块增减而产生变化，导致资源重新加载</p>
<h3 id="developmentproduction">development/production<a class="anchor" href="#developmentproduction">§</a></h3>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 命令行配置</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"webpack-merge"</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> commonConfig <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./webpack.common.js"</span><span class="token punctuation">)</span> 
<span class="token keyword">const</span> devConfig <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>commonConfig<span class="token punctuation">,</span>devConfig<span class="token punctuation">)</span>
 
<span class="token comment">//package.js </span>
<span class="token string">"scripts"</span><span class="token operator">:</span><span class="token punctuation">{</span>    
    <span class="token string">"dev"</span><span class="token operator">:</span><span class="token string">"webpack-dev-server --config ./build/webpack.dev.js"</span><span class="token punctuation">,</span>    
    <span class="token string">"build"</span><span class="token operator">:</span><span class="token string">"webpack --config ./build/webpack.prod.js"</span> 
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">//外部传入的全局变量 </span>
module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>env <span class="token operator">&amp;&amp;</span> env<span class="token punctuation">.</span><span class="token property-access">production</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">merge</span><span class="token punctuation">(</span>commonConfig<span class="token punctuation">,</span> prodConfig<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">merge</span><span class="token punctuation">(</span>commonConfig<span class="token punctuation">,</span> devConfig<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//外部传入变量 </span>
scripts<span class="token operator">:</span><span class="token string">" --env.production"</span>

</code></pre>
<h3 id="bundle%E4%BD%93%E7%A7%AF%E7%9B%91%E6%8E%A7%E5%92%8C%E5%88%86%E6%9E%90">bundle体积监控和分析<a class="anchor" href="#bundle%E4%BD%93%E7%A7%AF%E7%9B%91%E6%8E%A7%E5%92%8C%E5%88%86%E6%9E%90">§</a></h3>
<p>Vs code 插件 import Cost  可以实时显示引入模块的大小和压缩后的大小</p>
<h3 id="%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90webpack-bundle-analyzer">打包分析webpack-bundle-analyzer<a class="anchor" href="#%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90webpack-bundle-analyzer">§</a></h3>
<pre class="language-autoit"><code class="language-autoit">scripts<span class="token punctuation">:</span> {
  <span class="token string">"test:size"</span><span class="token punctuation">:</span> <span class="token string">"bundlesize"</span>
}
</code></pre>
<h3 id="%E9%80%9A%E8%BF%87%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9C%8B%E7%9C%8B%E4%BB%A3%E7%A0%81%E5%88%A9%E7%94%A8%E7%8E%87">通过控制台看看代码利用率<a class="anchor" href="#%E9%80%9A%E8%BF%87%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9C%8B%E7%9C%8B%E4%BB%A3%E7%A0%81%E5%88%A9%E7%94%A8%E7%8E%87">§</a></h3>
<h3 id="%E6%8A%8Ajs%E9%87%8Cimport%E7%9A%84%E5%BC%82%E6%AD%A5js%E6%96%87%E4%BB%B6%E6%8A%BD%E7%A6%BB%E5%A4%84%E7%90%86">把js里import的异步js文件抽离处理<a class="anchor" href="#%E6%8A%8Ajs%E9%87%8Cimport%E7%9A%84%E5%BC%82%E6%AD%A5js%E6%96%87%E4%BB%B6%E6%8A%BD%E7%A6%BB%E5%A4%84%E7%90%86">§</a></h3>
<pre class="language-autoit"><code class="language-autoit"> npm install <span class="token operator">-</span><span class="token operator">-</span>save<span class="token operator">-</span>dev <span class="token variable">@babel</span><span class="token operator">/</span>plugin<span class="token operator">-</span>syntax<span class="token operator">-</span>dynamic<span class="token operator">-</span>import 
</code></pre>
<h3 id="tree-shaking">tree-shaking<a class="anchor" href="#tree-shaking">§</a></h3>
<p>Tree-shaking起源于ES5模块打包工具rollup，依赖于ES2015模块系统中的静态树结构，可以移除js上下文中未引用的代码，有效减少代码文件的大小。</p>
<p>webpack3.x需要配置UglifyJsPlugin，会做Tree shaking</p>
<p>wbepack4.x需要指定mode为production</p>
<p>在项目中使用了 <a href="http://babeljs.io/">Babel</a> 的话，要把 Babel 解析模块语法的功能关掉，在 <code>.babelrc</code> 配置中增加 <code>&quot;modules&quot;: false</code> 这个配置：</p>
<pre class="language-autoit"><code class="language-autoit">{
  <span class="token string">"presets"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"env"</span><span class="token punctuation">,</span> { <span class="token string">"modules"</span><span class="token punctuation">:</span> <span class="token boolean">false</span> }<span class="token punctuation">]</span><span class="token punctuation">]</span>
}
</code></pre>
<p>这样可以把 <code>import/export</code> 的这一部分模块语法交由 webpack 处理，否则没法使用 Tree shaking 的优化。</p>
<h3 id="sideeffects">sideEffects<a class="anchor" href="#sideeffects">§</a></h3>
<p>webpack4.x中才有，</p>
<p>lodash工具库中函数，只用到其中的几个，webpack 的 sideEffects 可以帮助解决这个问题。</p>
<p>现在 lodash 的ES 版本 的 <code>package.json</code> 文件中已经有 <code>sideEffects: false</code> 这个声明了，当某个模块的 <code>package.json</code> 文件中有了这个声明之后，webpack 会认为这个模块没有任何副作用，只是单纯用来对外暴露模块使用，那么在打包的时候就会做一些额外的处理。</p>
<p>例如你这么使用 <code>lodash</code>：</p>
<pre class="language-autoit"><code class="language-autoit">import { forEach<span class="token punctuation">,</span> includes } from <span class="token string">'lodash-es'</span>

<span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> {
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
}<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
<p>由于 lodash-es 这个模块的 <code>package.json</code> 文件有 <code>sideEffects: false</code> 的声明，所以 webpack 会将上述的代码转换为以下的代码去处理：</p>
<p>把没有引用的代码去掉</p>
<pre class="language-autoit"><code class="language-autoit"><span class="token operator">/</span><span class="token operator">/</span>webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js
optimization<span class="token punctuation">:</span> {    
  usedExports<span class="token punctuation">:</span> <span class="token boolean">true</span>  
}
<span class="token operator">/</span><span class="token operator">/</span>package<span class="token punctuation">.</span>json <span class="token string">"sideEffects"</span><span class="token punctuation">:</span><span class="token boolean">false</span>  正常对所有模块进行tree shaking  或者 <span class="token string">"sideEffects"</span><span class="token punctuation">[</span><span class="token string">'*.css'</span><span class="token punctuation">,</span><span class="token string">'@babel/polyfill'</span><span class="token punctuation">]</span>

</code></pre></article><div class="prev_next"><a class="prev button" href="/webpack/webpack-custom-plugin.html">«  <!-- -->实现自己的plugin</a><a class="next button" href="/webpack/webpack-dev-server-hmr.html">webpack-dev-server 与 HMR<!-- -->  »</a></div></div><aside class="main_toc_container nav_link_container"><div class="main_toc"><nav class="toc"><ol><li><a href="#%E9%80%9A%E8%BF%87%E5%85%A5%E5%8F%A3%E6%8B%86%E5%88%86%E4%BB%A3%E7%A0%81">通过入口拆分代码</a></li><li><a href="#commonschunkplugin">CommonsChunkPlugin</a><ol><li><a href="#webpack4x%E9%80%82%E7%94%A8optimizationsplitchunks-%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2">webpack4.x适用optimization.SplitChunks 代码分割</a></li></ol></li><li><a href="#%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD">异步加载</a><ol><li><a href="#developmentproduction">development/production</a></li><li><a href="#bundle%E4%BD%93%E7%A7%AF%E7%9B%91%E6%8E%A7%E5%92%8C%E5%88%86%E6%9E%90">bundle体积监控和分析</a></li><li><a href="#%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90webpack-bundle-analyzer">打包分析webpack-bundle-analyzer</a></li><li><a href="#%E9%80%9A%E8%BF%87%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9C%8B%E7%9C%8B%E4%BB%A3%E7%A0%81%E5%88%A9%E7%94%A8%E7%8E%87">通过控制台看看代码利用率</a></li><li><a href="#%E6%8A%8Ajs%E9%87%8Cimport%E7%9A%84%E5%BC%82%E6%AD%A5js%E6%96%87%E4%BB%B6%E6%8A%BD%E7%A6%BB%E5%A4%84%E7%90%86">把js里import的异步js文件抽离处理</a></li><li><a href="#tree-shaking">tree-shaking</a></li><li><a href="#sideeffects">sideEffects</a></li></ol></li></ol></nav></div></aside></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><div class="tools flex_center hide_on_mobile"><a class="czs-angle-up-l button" href="#" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></a></div><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>