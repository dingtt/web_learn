<!doctype html><html class="" data-reactroot=""><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端笔记"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">实现自己的loader · Ding前端笔记</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><header><h1 class="hide_on_mobile"><a href="/">Ding前端笔记</a></h1><nav><ul><li class="show_on_mobile flex_center"><a class="czs-menu-l" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a></li><li class="show_on_mobile"><h1 class="mobile_title"><a href="/">Ding前端笔记</a></h1></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul></nav></header><aside class="sidebar"><ol class="list_style_none"><li class=""><a href="/index.html" class="nav_link">Hello world</a></li><li class="unfold"><a href="/WebAPI/README.md" class="nav_link">WebAPI/README.md<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"></ol></li><li class="unfold"><a href="/HTTP/index.html" class="nav_link">HTTP协议与浏览器<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/HTTP/browser.html" class="nav_link">浏览器</a></li><li class=""><a href="/HTTP/HTTP.html" class="nav_link">HTTP协议请求方法和状态码</a></li><li class=""><a href="/HTTP/internet-hardware.html" class="nav_link">网络硬件</a></li></ol></li><li class="unfold"><a href="/js/todo.md" class="nav_link">js/todo.md<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/js/basics.html" class="nav_link">JavaScript基础</a></li><li class=""><a href="/js/Object.html" class="nav_link">基础</a></li><li class=""><a href="/js/context.html" class="nav_link">执行上下文</a></li><li class=""><a href="/js/closure.html" class="nav_link">闭包和面向对象</a></li><li class=""><a href="/js/regex.html" class="nav_link">正则</a></li><li class=""><a href="/js/algo.html" class="nav_link">算法</a></li><li class=""><a href="/js/design-patterns.html" class="nav_link">JS设计模式</a></li></ol></li><li class="unfold"><a href="/TS/index.html" class="nav_link">TS<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/TS/basics.html" class="nav_link">TS基础</a></li><li class=""><a href="/TS/enum.html" class="nav_link">TS枚举 类型 接口 泛型</a></li></ol></li><li class="unfold"><a href="/vue/index.html" class="nav_link">Vue<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/vue/vue-skills.html" class="nav_link">Vue开发技巧</a></li><li class=""><a href="/vue/vue-communication.html" class="nav_link">Vue组件通信</a></li><li class=""><a href="/vue/vue-router/vue-router.html" class="nav_link">Vue路由</a></li></ol></li><li class=""><a href="/react/lifecycle.html" class="nav_link">React的生命周期</a></li><li class="unfold"><a href="/webpack/index.html" class="nav_link">Webpack<span class="czs-angle-up-l" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></span><span class="czs-angle-down-l" style="background-image:url(&quot;/assets/czs-angle-down-l.svg&quot;)"></span></a><ol class="list_style_none" style="height:auto"><li class=""><a href="/webpack/webpack-use.html" class="nav_link">webpack的使用</a></li><li class=""><a href="/webpack/webpack-principle.html" class="nav_link">Webpack打包原理解析</a></li><li class=""><a href="/webpack/webpack-dev-config.html" class="nav_link">生产环境配置</a></li><li class=""><a href="/webpack/webpack-custom-loader.html" class="nav_link active">实现自己的loader</a></li><li class=""><a href="/webpack/webpack-custom-plugin.html" class="nav_link">实现自己的plugin</a></li><li class=""><a href="/webpack/webpack-split-chunks.html" class="nav_link">webpack代码分片</a></li><li class=""><a href="/webpack/webpack-dev-server-hmr.html" class="nav_link">webpack-dev-server 与 HMR</a></li></ol></li><li class=""><a href="/web-monitor/web-monitor.html" class="nav_link">前端监控简介</a></li><li class=""><a href="/git/git.html" class="nav_link">Git使用</a></li></ol></aside><section class="main"><div class="main_article"><article><h1>实现自己的loader</h1>
<h3 id="loader%E5%8E%9F%E7%90%86">loader原理<a class="anchor" href="#loader%E5%8E%9F%E7%90%86">§</a></h3>
<p>loader本身就是一个函数，对接收到的内容进行转换，然后返回转换后的结果。声明式函数，不能⽤用箭头函数</p>
<p>content是模块内容，可以是字符串，Buffer，map是sourcemap对象，meta是其他一些元数据</p>
<pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> map<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// var callback = this.async() // 异步事件的适合使用this.async，返回的是callback函数  </span>
  <span class="token comment">// setTimeout(() => {    </span>
      <span class="token comment">// ...    </span>
      <span class="token comment">//callback(null, result)  </span>
  <span class="token comment">// }, 3000);</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">handler</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> map<span class="token punctuation">,</span> meta<span class="token punctuation">)</span>
  <span class="token comment">// loader函数本身只返回一个值，如果需要返回sourcemap或者meta对象等多个值，需要使用this.callback()</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">callback</span><span class="token punctuation">(</span>
   <span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token comment">// error 自行赋值</span>
   result<span class="token punctuation">.</span><span class="token property-access">content</span><span class="token punctuation">,</span> <span class="token comment">// 转换后的内容  string Buffer</span>
   result<span class="token punctuation">.</span><span class="token property-access">map</span><span class="token punctuation">,</span> <span class="token comment">// 转换后的source-map</span>
   result<span class="token punctuation">.</span><span class="token property-access">meta</span> <span class="token comment">// 转换后的AST</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9B%AE%E5%BD%95--my-diy-loader">创建一个目录  my-diy-loader<a class="anchor" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9B%AE%E5%BD%95--my-diy-loader">§</a></h3>
<p>npm init -y</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// my-diy-loader/index.js</span>
<span class="token comment">// 还可以安装引入其他的依赖</span>
<span class="token keyword">var</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"loader-utils"</span><span class="token punctuation">)</span> <span class="token comment">// loader-utils是webpack官方提供的处理loader，query的库</span>
<span class="token keyword">var</span> <span class="token maybe-class-name">SourceNode</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'source-map'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">SourceNode</span></span> <span class="token comment">// source-map便于开发调试在控制台中查看源码</span>
<span class="token keyword">var</span> <span class="token maybe-class-name">SourceMapConsumer</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"source-map"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">SourceMapConsumer</span></span> <span class="token comment">// 如果不处理sourece-map无法生成正确的map文件</span>
module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> soureceMap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cacheable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 缓存</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">cacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//this.query 通过this.query来接受配置⽂文件传递进来的参数</span>
  <span class="token keyword">var</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token method function property-access">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 获取options</span>
  <span class="token comment">// source-map</span>
  <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token property-access">sourceMap</span> <span class="token operator">&amp;&amp;</span> sourceMap<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取sourceMap对象</span>
    <span class="token keyword">var</span> currentRequest <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token method function property-access">getRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> node <span class="token operator">=</span> <span class="token maybe-class-name">SourceNode</span><span class="token punctuation">.</span><span class="token method function property-access">fromStringWithSourceMap</span><span class="token punctuation">(</span> <span class="token comment">// </span>
      content<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">SourceMapConsutomer</span><span class="token punctuation">(</span>sourceMap<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    node<span class="token punctuation">.</span><span class="token method function property-access">prepend</span><span class="token punctuation">(</span><span class="token string">'添加内容'</span><span class="token punctuation">)</span> <span class="token comment">// 对内容进行改动</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token method function property-access">toStringWithSourceMap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>file<span class="token operator">:</span>currentRequest<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 产生新的source-map</span>
    <span class="token keyword">var</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token property-access">code</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token property-access">map</span><span class="token punctuation">.</span><span class="token method function property-access">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 直接返回content</span>
  <span class="token comment">// return content</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8">安装使用<a class="anchor" href="#%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8">§</a></h3>
<p>npm install <path-to-loader>/mt-diy-loader</p>
<pre class="language-javascript"><code class="language-javascript">rules<span class="token operator">:</span> <span class="token punctuation">[</span>
 <span class="token punctuation">{</span>
   test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
   use<span class="token operator">:</span><span class="token string">'my-diy-loader'</span><span class="token punctuation">,</span>
   options<span class="token operator">:</span> <span class="token punctuation">{</span>
     sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre>
<pre class="language-javascript"><code class="language-javascript">rules<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token comment">// loader:path.resolve('./loader/index.js') // 使用本地的loader文件作为loader</span>
    loader<span class="token operator">:</span><span class="token punctuation">[</span>
        path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./loader/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        loader<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"./loader/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token comment">// 在resolveLoaderz中添加本地开发的loaders存方路径，适合同时需要开发多个loader</span>
resolveLoaders<span class="token operator">:</span> <span class="token punctuation">{</span>
    modules<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
        path<span class="token punctuation">.</span><span class="token method function property-access">resolver</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'loaders'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

module<span class="token operator">:</span> <span class="token punctuation">{</span>
  rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"replaceLoader"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token string">"replaceLoaderAsync"</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"开课吧"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token comment">// use: [path.resolve(__dirname, "./loader/index.js")]      </span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<p>另外也可以使用 <code>npm link</code> 的方式来开发和调试</p>
<p><strong>处理loader路径的问题</strong> ？？？</p>
<h3 id="pitching-loader">Pitching loader<a class="anchor" href="#pitching-loader">§</a></h3>
<p>使用pitch来跳过loader的处理，pitch方法是loader额外实现的一个函数</p>
<pre class="language-autoit"><code class="language-autoit">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>{
  return <span class="token function">someSyncOperation</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> this<span class="token punctuation">.</span>data<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">/</span><span class="token operator">/</span> 这里的data<span class="token punctuation">.</span>value
}
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>remainRequest<span class="token punctuation">,</span> precedingRequest<span class="token punctuation">,</span> data<span class="token punctuation">)</span>{
  data<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">11</span>
}
</code></pre>
<p>pitch的执行顺序是和loader相反的，如果有值返回，则跳过剩下的loader</p></article><div class="prev_next"><a class="prev button" href="/webpack/webpack-dev-config.html">«  <!-- -->生产环境配置</a><a class="next button" href="/webpack/webpack-custom-plugin.html">实现自己的plugin<!-- -->  »</a></div></div><aside class="main_toc_container nav_link_container"><div class="main_toc"><nav class="toc"><ol><li><a href="#loader%E5%8E%9F%E7%90%86">loader原理</a></li><li><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9B%AE%E5%BD%95--my-diy-loader">创建一个目录  my-diy-loader</a></li><li><a href="#%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8">安装使用</a></li><li><a href="#pitching-loader">Pitching loader</a></li></ol></nav></div></aside></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><div class="tools flex_center hide_on_mobile"><a class="czs-angle-up-l button" href="#" style="background-image:url(&quot;/assets/czs-angle-up-l.svg&quot;)"></a></div><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>